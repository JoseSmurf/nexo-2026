name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Cache cargo + target
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin
          ~/.cargo/registry/index
          ~/.cargo/registry/cache
          ~/.cargo/git/db
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-fmt
        restore-keys: |
          ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-
          ${{ runner.os }}-cargo-
    - name: Install rustfmt
      run: rustup component add rustfmt
    - name: Format check
      run: cargo fmt --check

  clippy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Cache cargo + target
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin
          ~/.cargo/registry/index
          ~/.cargo/registry/cache
          ~/.cargo/git/db
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-clippy
        restore-keys: |
          ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-
          ${{ runner.os }}-cargo-
    - name: Install clippy
      run: rustup component add clippy
    - name: Clippy fail-closed
      run: cargo clippy --all-targets --all-features -- -D warnings

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Cache cargo + target
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin
          ~/.cargo/registry/index
          ~/.cargo/registry/cache
          ~/.cargo/git/db
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-security
        restore-keys: |
          ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-
          ${{ runner.os }}-cargo-
    - name: Install cargo-deny
      uses: taiki-e/install-action@cargo-deny
    - name: cargo-deny check
      run: cargo deny check

  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Cache cargo + target
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin
          ~/.cargo/registry/index
          ~/.cargo/registry/cache
          ~/.cargo/git/db
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-build
        restore-keys: |
          ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-
          ${{ runner.os }}-cargo-
    - name: Setup Zig 0.11.0 (offline audit verifier)
      uses: mlugg/setup-zig@v1
      with:
        version: 0.11.0
    - name: Setup Julia
      uses: julia-actions/setup-julia@v2
      with:
        version: '1.12'
    - name: Build
      run: cargo build --verbose
    - name: Run tests
      run: cargo test --verbose
    - name: Run Julia tests
      run: |
        julia --project=./julia -e 'using Pkg; Pkg.instantiate()'
        julia --project=./julia julia/test_plca.jl
    - name: Run Julia integration test (bridge -> API)
      run: julia --project=./julia julia/test_integration.jl
    - name: Verify audit hash offline (Zig)
      run: |
        cd tools/zig
        zig build test
        zig build run -- verify ../../fixtures/audit_sample.jsonl

  bench:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    needs: [build]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Cache cargo + target
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin
          ~/.cargo/registry/index
          ~/.cargo/registry/cache
          ~/.cargo/git/db
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-bench
        restore-keys: |
          ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-
          ${{ runner.os }}-cargo-
    - name: Enforce perf budget
      run: cargo run --release --bin perf_budget
    - name: Continuous load test
      run: |
        NEXO_LOAD_REQUESTS=600 \
        NEXO_LOAD_CONCURRENCY=60 \
        NEXO_LOAD_MAX_P95_US=400 \
        NEXO_LOAD_MAX_P99_US=1200 \
        NEXO_ALERT_MAX_ERROR_RATE_PCT=0.00 \
        NEXO_ALERT_MAX_401=0 \
        NEXO_ALERT_MAX_408=0 \
        NEXO_ALERT_MAX_409=0 \
        NEXO_ALERT_MAX_429=0 \
        cargo run --release --bin load_test
