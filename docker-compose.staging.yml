services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      NEXO_PROFILE: br_default_v1
      NEXO_AUDIT_PATH: /app/logs/audit_records.jsonl
      NEXO_AUDIT_RETENTION: "5000"
      NEXO_AUTH_WINDOW_MS: "60000"
      NEXO_REPLAY_TTL_MS: "120000"
      NEXO_REPLAY_MAX_KEYS: "100000"
      NEXO_RATE_LIMIT_WINDOW_MS: "60000"
      NEXO_RATE_LIMIT_IP: "600"
      NEXO_RATE_LIMIT_USER: "300"
      NEXO_SECRET_PROVIDER: none
      NEXO_HMAC_SECRET_FILE: /run/secrets/hmac_secret
      NEXO_HMAC_KEY_ID_FILE: /run/secrets/hmac_key_id
      NEXO_MTLS_REQUIRED: "true"
      NEXO_MTLS_VERIFIED_HEADER: x-client-cert-verified
      NEXO_MTLS_VERIFIED_VALUE: SUCCESS
      NEXO_CLIENT_SIG_REQUIRED: "true"
      NEXO_CLIENT_ID_HEADER: x-client-id
      NEXO_CLIENT_SIGNATURE_HEADER: x-client-signature
      NEXO_CLIENT_PUBKEYS_FILE: /run/secrets/client_pubkeys.json
    volumes:
      - ./staging/secrets/hmac_secret:/run/secrets/hmac_secret:ro
      - ./staging/secrets/hmac_key_id:/run/secrets/hmac_key_id:ro
      - ./staging/secrets/client_pubkeys.json:/run/secrets/client_pubkeys.json:ro
      - ./logs:/app/logs
    expose:
      - "3000"
    networks:
      - nexo_staging

  edge:
    image: nginx:1.27-alpine
    depends_on:
      - api
    ports:
      - "3443:3443"
    volumes:
      - ./staging/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./staging/certs:/etc/nginx/certs:ro
    networks:
      - nexo_staging

networks:
  nexo_staging:
    driver: bridge
